<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高機能家計簿アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* カスタムスタイル */
        :root { --card-padding: 24px; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f7f8fa; /* 少し柔らかい背景色に変更 */
            color: #333;
            transition: padding-bottom 0.3s ease;
        }
        .main-container { max-width: 1400px; margin: 0 auto; }
        .card {
            background-color: white;
            border-radius: 16px; /* 角を少し丸く */
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: var(--card-padding);
            transition: all 0.3s ease;
        }
        .clickable-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }
        .modal { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .modal.is-open { display: flex; opacity: 1; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-dot.loading, .status-dot.saving, .status-dot.ai { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .toggle-btn.active { background-color: #4f46e5; color: white; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3); }
        .toggle-btn { background-color: #e5e7eb; transition: all 0.2s ease; }
        .toggle-btn:hover { background-color: #d1d5db; }
        .toggle-btn.active:hover { background-color: #4338ca; }

        /* スマートフォンUI用スタイル */
        #bottom-nav { display: none; }
        .mobile-view { --card-padding: 16px; }
        .mobile-view #bottom-nav {
            display: flex;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            z-index: 30;
        }
        .mobile-view .main-container { padding: 0.75rem; padding-bottom: 80px; }
        .mobile-view #add-transaction-desktop-btn { display: none; }
    </style>
</head>
<body class="">

    <div id="app-container" class="main-container p-4 md:p-6 lg:p-8">
        <header class="flex flex-col md:flex-row justify-between items-start mb-8">
            <div>
                <h1 class="text-4xl font-bold text-gray-800">家計簿</h1>
                <p id="dashboard-subtitle" class="text-gray-500 mt-1">ダッシュボード</p>
            </div>
            <div class="w-full md:w-auto mt-4 md:mt-0 text-right space-y-2">
                 <div class="flex items-center justify-end gap-2">
                    <button id="view-toggle-btn" title="表示切替" class="bg-white h-10 w-10 flex items-center justify-center rounded-lg border shadow-sm text-gray-600 hover:bg-gray-100"><i class="fas fa-desktop"></i></button>
                    <div id="status-container" class="flex items-center justify-end p-2 bg-white rounded-lg border shadow-sm">
                        <div id="save-status"></div>
                        <button id="force-sync-btn" title="手動同期" class="ml-2 text-gray-500 hover:text-indigo-600"><i class="fas fa-sync-alt"></i></button>
                    </div>
                 </div>
                <div id="auth-container" class="text-xs text-gray-500 p-2 bg-white rounded-lg border">
                    <p id="auth-info">読み込み中...</p>
                    <button id="google-login-btn" class="hidden w-full text-left text-sm text-gray-700 px-3 py-1.5 rounded-md hover:bg-gray-100 mt-2 border">
                      <i class="fab fa-google mr-2 text-red-500"></i>Googleでログイン
                    </button>
                    <button id="logout-btn" class="hidden w-full text-left text-sm text-gray-700 px-3 py-1.5 rounded-md hover:bg-gray-100 mt-2 border">
                        <i class="fas fa-right-from-bracket mr-2"></i>ログアウト
                    </button>
                </div>
            </div>
        </header>

        <main id="main-content">
            <div id="dashboard-view">
                <div class="grid grid-cols-1 xl:grid-cols-5 gap-8">
                    <div class="xl:col-span-3 space-y-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div id="balance-card" class="card clickable-card flex items-center"><div class="p-3 mr-4 bg-blue-100 rounded-full"><i class="fas fa-wallet fa-lg text-blue-500"></i></div><div><h2 class="text-gray-500">現在の残高</h2><p id="current-balance" class="text-2xl md:text-3xl font-bold mt-1">¥0</p></div></div>
                            <div id="income-card" class="card clickable-card flex items-center"><div class="p-3 mr-4 bg-green-100 rounded-full"><i class="fas fa-arrow-up fa-lg text-green-500"></i></div><div><h2 class="text-gray-500">今月の収入</h2><p id="total-income" class="text-2xl md:text-3xl font-bold mt-1 text-green-600">¥0</p></div></div>
                            <div id="expense-card" class="card clickable-card flex items-center"><div class="p-3 mr-4 bg-red-100 rounded-full"><i class="fas fa-arrow-down fa-lg text-red-500"></i></div><div><h2 class="text-gray-500">今月の支出</h2><p id="total-expense" class="text-2xl md:text-3xl font-bold mt-1 text-red-600">¥0</p></div></div>
                        </div>
                        <div class="card"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">週間支出</h2><i class="fas fa-chart-line text-2xl text-gray-300"></i></div><div class="w-full h-60"><canvas id="weekly-expense-chart"></canvas></div></div>
                        <div class="card bg-gradient-to-br from-indigo-50 to-purple-50">
                            <h2 class="text-2xl font-bold mb-4 text-indigo-800">今月のAIサマリー ✨</h2>
                            <div id="ai-summary-content" class="text-gray-600 prose prose-sm max-w-none mb-4 min-h-[50px]"><p>下のボタンを押して、今月の支出傾向をAIに分析してもらいましょう。</p></div>
                            <button id="get-ai-summary-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm hover:shadow-md transition-shadow"><i class="fas fa-wand-magic-sparkles mr-2"></i>サマリーを生成</button>
                        </div>
                    </div>
                    <div class="xl:col-span-2 space-y-8">
                         <div id="expense-chart-card" class="card clickable-card"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">支出カテゴリ</h2><i class="fas fa-chart-pie text-2xl text-gray-300"></i></div><div class="w-full h-64 flex justify-center items-center relative"><canvas id="dashboard-chart-canvas"></canvas></div></div>
                         <div class="card"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">最近の取引履歴</h2><i class="fas fa-history text-2xl text-gray-300"></i></div><div id="transaction-list" class="space-y-2 max-h-[400px] overflow-y-auto pr-2"></div></div>
                         <div class="card"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">予算管理</h2><i class="fas fa-bullseye text-2xl text-gray-300"></i></div><div id="budget-list" class="space-y-4 max-h-[300px] overflow-y-auto pr-2"></div><form id="budget-form" class="mt-6 flex gap-2"><select id="budget-category" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50"></select><input type="number" id="budget-amount" placeholder="予算額" class="w-full p-2 border border-gray-300 rounded-lg" required><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">設定</button></form></div>
                         <div class="card"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">データ管理</h2><i class="fas fa-cogs text-2xl text-gray-300"></i></div><div class="flex flex-col space-y-3"><button id="download-json-btn" class="w-full text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg"><i class="fas fa-file-code w-6 mr-2 text-gray-500"></i>JSONでダウンロード</button><button id="download-csv-btn" class="w-full text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg"><i class="fas fa-file-csv w-6 mr-2 text-gray-500"></i>CSVでダウンロード</button><button id="get-ai-tips-btn" class="w-full text-left p-3 bg-indigo-100 hover:bg-indigo-200 rounded-lg text-indigo-800"><i class="fas fa-lightbulb w-6 mr-2"></i>節約術を提案 ✨</button></div></div>
                    </div>
                </div>
            </div>
            
            <div id="detail-view" class="hidden"></div>
        </main>
    </div>

    <nav id="bottom-nav">
        <button data-view="dashboard" class="nav-btn flex-1 p-2 text-center text-gray-600"><i class="fas fa-home text-2xl"></i><span class="block text-xs">ホーム</span></button>
        <button data-view="all" class="nav-btn flex-1 p-2 text-center text-gray-600"><i class="fas fa-list text-2xl"></i><span class="block text-xs">全履歴</span></button>
        <button id="add-transaction-mobile-btn" class="flex-1 p-2 text-center text-white bg-indigo-600 rounded-full w-16 h-16 transform -translate-y-4 shadow-lg"><i class="fas fa-plus text-3xl"></i></button>
        <button data-view="graph" class="nav-btn flex-1 p-2 text-center text-gray-600"><i class="fas fa-chart-pie text-2xl"></i><span class="block text-xs">分析</span></button>
        <button data-view="budget" class="nav-btn flex-1 p-2 text-center text-gray-600"><i class="fas fa-bullseye text-2xl"></i><span class="block text-xs">予算</span></button>
    </nav>
    
    <button id="add-transaction-desktop-btn" title="取引を追加" class="hidden md:block fixed bottom-8 right-8 bg-indigo-600 hover:bg-indigo-700 text-white w-16 h-16 rounded-full shadow-lg hover:shadow-xl flex items-center justify-center text-3xl transform hover:scale-105 transition-all">
        <i class="fas fa-plus"></i>
    </button>

    <div id="transaction-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-40"></div>
    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"></div>
    <div id="ai-tips-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50"></div>
    <div id="toast-container" class="fixed top-5 right-5 z-50"></div>

    <script type="module">
        // config.jsの内容をここに直接記述
        const __firebase_config = {
            apiKey: "AIzaSyC8xib8Xsp2SHVl4ICXVSYkoKHFCQavbVY",
            authDomain: "kakeibo-app-20c96.firebaseapp.com",
            projectId: "kakeibo-app-20c96",
            storageBucket: "kakeibo-app-20c96.appspot.com",
            messagingSenderId: "298884559373",
            appId: "1:298884559373:web:df7ad151ac63e3fcb9db44",
            measurementId: "G-G27RXBKGES"
        };
        const __app_id = "kakeibo-app-20c96";

        // app.jsの内容をここにペースト
        // Firebaseライブラリをインポート
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, query, deleteDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // === グローバル変数と設定 ===
        let db, auth, userId, isAuthReady = false;
        let weeklyChart = null, dashboardChart = null, detailChart = null;
        let localTransactions = [], localBudgets = [];
        let unsubscribeTransactions = () => {}, unsubscribeBudgets = () => {};

        const categories = {
            income: ['給与', '賞与', '副業', '臨時収入', 'その他'],
            expense: ['飲食費', '日用品', '住居費', '交通費', '交際費', '趣味・娯楽', '教育・自己投資', '医療費', '水道・光熱費', '通信費', '税金・保険', 'その他']
        };
        const chartColors = {
            expense: ['#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1'],
            income: ['#22c55e', '#84cc16', '#3b82f6', '#6366f1', '#a855f7']
        };

        // === 初期化処理 ===
        document.addEventListener('DOMContentLoaded', () => {
            try {
                if (typeof __firebase_config === 'undefined' || !__firebase_config.projectId) {
                    throw new Error("Firebase設定が見つかりません。");
                }
                const app = initializeApp(__firebase_config);
                db = getFirestore(app);
                auth = getAuth(app);
                
                setupEventListeners();
                setSaveStatus('loading');
                
                onAuthStateChanged(auth, user => {
                    unsubscribeAll();
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        displayAuthInfo(user);
                        initializeAppState();
                    } else {
                        isAuthReady = false;
                        userId = null;
                        displayAuthInfo(null);
                        signInAnonymously(auth).catch(() => setSaveStatus('error', '匿名ログインに失敗'));
                    }
                });
            } catch (error) {
                console.error("初期化エラー:", error);
                setSaveStatus('error', 'アプリの初期化に失敗');
            }
        });

        function initializeAppState() {
            if (!isAuthReady || !userId) return;
            loadAndDisplayData();
        }

        function unsubscribeAll() {
            unsubscribeTransactions();
            unsubscribeBudgets();
        }

        // === データ関連 ===
        function loadAndDisplayData() {
            if (!isAuthReady || !userId) return;
            setSaveStatus('loading');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-kakeibo-app';
            const transCol = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
            unsubscribeTransactions = onSnapshot(query(transCol), snapshot => {
                localTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                localTransactions.sort((a, b) => (b.date?.toDate() ?? 0) - (a.date?.toDate() ?? 0));
                updateUI();
                setSaveStatus('idle');
            }, () => setSaveStatus('error', '取引データの同期に失敗'));

            const budgetCol = collection(db, `artifacts/${appId}/users/${userId}/budgets`);
            unsubscribeBudgets = onSnapshot(query(budgetCol), snapshot => {
                localBudgets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            }, () => setSaveStatus('error', '予算データの同期に失敗'));
        }

        async function handleFirestoreWrite(promise) {
            setSaveStatus('saving');
            try {
                await promise;
                setSaveStatus('idle');
                return true;
            } catch (error) {
                setSaveStatus('error', 'データの保存に失敗しました');
                return false;
            }
        }
        
        // === Gemini API 関連 ===
        async function callGeminiAPI(prompt) {
            setSaveStatus('ai', 'AIが考え中...');
            const apiKey = ""; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    temperature: 0.5,
                    topK: 1,
                    topP: 1,
                    maxOutputTokens: 2048,
                },
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0) {
                    setSaveStatus('idle');
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("AIからの有効な応答がありません。");
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                setSaveStatus('error', 'AIの応答に失敗');
                return null;
            }
        }

        async function getAISummary() {
            const monthlyTransactions = localTransactions.filter(t => t.date?.toDate() >= new Date(new Date().getFullYear(), new Date().getMonth(), 1));
            if (monthlyTransactions.length === 0) {
                document.getElementById('ai-summary-content').innerHTML = `<p>今月の取引データがないため、分析できません。</p>`;
                return;
            }

            const prompt = `あなたは優秀なファイナンシャルアドバイザーです。以下の家計簿データ（今月分）を分析し、ユーザーの支出傾向を分かりやすく要約してください。重要なポイントを箇条書きで示し、最後に簡単なアドバイスを添えてください。フレンドリーな口調でお願いします。\n\nデータ:\n${JSON.stringify(monthlyTransactions.map(t => ({type: t.type, category: t.category, amount: t.amount})))}`;
            
            const summaryContentEl = document.getElementById('ai-summary-content');
            summaryContentEl.innerHTML = `<div class="flex items-center"><div class="status-dot ai"></div><p>AIが分析中...</p></div>`;

            const result = await callGeminiAPI(prompt);
            if (result) {
                summaryContentEl.innerHTML = result.replace(/\n/g, '<br>');
            } else {
                summaryContentEl.innerHTML = `<p class="text-red-500">AIサマリーの生成に失敗しました。</p>`;
            }
        }

        async function getAICategory(description) {
            const prompt = `以下の取引内容に最も適したカテゴリを、次の選択肢の中から一つだけ選んでください。\n\n選択肢: ${categories.expense.join(', ')}, ${categories.income.join(', ')}\n\n取引内容: "${description}"\n\nカテゴリ:`;
            const result = await callGeminiAPI(prompt);
            if (result) {
                const suggestedCategory = result.trim();
                const allCategories = [...categories.expense, ...categories.income];
                if (allCategories.includes(suggestedCategory)) {
                    const select = document.querySelector('#transaction-modal #transaction-category');
                    const type = categories.income.includes(suggestedCategory) ? 'income' : 'expense';
                    const form = document.querySelector('#transaction-modal #transaction-form');
                    const incomeBtn = document.getElementById('type-income-btn');
                    const expenseBtn = document.getElementById('type-expense-btn');

                    form.elements['transaction-type'].value = type;
                    incomeBtn.classList.toggle('active', type === 'income');
                    expenseBtn.classList.toggle('active', type === 'expense');
                    
                    select.innerHTML = (type === 'income' ? categories.income : categories.expense).map(cat => `<option value="${cat}">${cat}</option>`).join('');
                    select.value = suggestedCategory;
                }
            }
        }
        
        async function getAITips() {
            const prompt = `あなたは節約の達人です。以下の最近の支出データに基づき、ユーザーに実行可能で具体的な節約術を3つ提案してください。箇条書きで、なぜそれが有効なのか簡単な理由も添えてください。\n\n支出データ:\n${JSON.stringify(localTransactions.filter(t=>t.type==='expense').slice(0, 30).map(t => ({category: t.category, amount: t.amount})))}`;

            const modalContainer = document.getElementById('ai-tips-modal');
            modalContainer.innerHTML = `<div class="card w-full max-w-lg"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-indigo-800">AIからの節約アドバイス ✨</h2><button id="close-ai-tips-modal" class="text-gray-500 hover:text-gray-800"><i class="fas fa-times fa-2x"></i></button></div><div id="ai-tips-content" class="prose max-w-none"><div class="flex items-center"><div class="status-dot ai"></div><p>あなたに合った節約術を考えています...</p></div></div></div>`;
            modalContainer.classList.add('is-open');
            document.getElementById('close-ai-tips-modal').addEventListener('click', () => modalContainer.classList.remove('is-open'));

            const result = await callGeminiAPI(prompt);
            const contentEl = document.getElementById('ai-tips-content');
            if (result) {
                contentEl.innerHTML = result.replace(/\n/g, '<br>');
            } else {
                contentEl.innerHTML = `<p class="text-red-500">提案の生成に失敗しました。</p>`;
            }
        }


        // === UI更新 & レンダリング ===
        function updateUI() {
            const detailView = document.getElementById('detail-view');
            if (detailView.classList.contains('hidden')) {
                renderDashboard();
            } else {
                const currentView = detailView.dataset.currentView;
                if (currentView) navigateTo(currentView, true);
            }
        }

        function renderDashboard() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthlyTransactions = localTransactions.filter(t => t.date?.toDate() >= startOfMonth);
            const income = monthlyTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = monthlyTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = localTransactions.reduce((sum, t) => t.type === 'income' ? sum + t.amount : sum - t.amount, 0);
            
            document.getElementById('current-balance').textContent = `¥${balance.toLocaleString()}`;
            document.getElementById('total-income').textContent = `¥${income.toLocaleString()}`;
            document.getElementById('total-expense').textContent = `¥${expense.toLocaleString()}`;

            const listEl = document.getElementById('transaction-list');
            listEl.innerHTML = '';
            if (localTransactions.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 p-4">取引データがありません。</p>';
            } else {
                localTransactions.slice(0, 10).forEach(t => listEl.appendChild(createTransactionItem(t)));
            }
            
            renderCategoryChart(document.getElementById('dashboard-chart-canvas'), monthlyTransactions, 'expense', 'doughnut', true);
            renderWeeklyExpenseChart();
            renderBudgets();
        }

        function renderDetailView(viewName, title, content) {
            const detailView = document.getElementById('detail-view');
            detailView.dataset.currentView = viewName;
            document.getElementById('dashboard-subtitle').textContent = title;
            detailView.innerHTML = `<div class="card">${content}</div>`;
        }

        function renderTransactionDetailPage(type) {
            const title = type === 'all' ? '全取引履歴' : type === 'income' ? '収入履歴' : '支出履歴';
            const transactions = localTransactions.filter(t => type === 'all' || t.type === type);
            let listContent = '<p class="text-gray-500 p-4">対象の取引データがありません。</p>';
            if (transactions.length > 0) {
                const dailyGroups = transactions.reduce((acc, t) => {
                    const dateStr = t.date.toDate().toLocaleDateString('ja-JP');
                    if (!acc[dateStr]) acc[dateStr] = { transactions: [], total: 0 };
                    acc[dateStr].transactions.push(t);
                    acc[dateStr].total += t.type === 'income' ? t.amount : -t.amount;
                    return acc;
                }, {});

                listContent = Object.entries(dailyGroups).map(([date, group]) => `
                    <div class="mb-4">
                        <div class="flex justify-between items-baseline mb-2 pb-1 border-b">
                            <h3 class="font-bold text-lg">${date}</h3>
                            <p class="text-sm font-semibold ${group.total >= 0 ? 'text-green-600' : 'text-red-600'}">合計: ${group.total.toLocaleString()}円</p>
                        </div>
                        <div class="space-y-2">${group.transactions.map(t => createTransactionItem(t).outerHTML).join('')}</div>
                    </div>
                `).join('');
                listContent = `<div class="max-h-[75vh] overflow-y-auto pr-2">${listContent}</div>`;
            }
            renderDetailView(type, title, listContent);
            document.querySelectorAll('.delete-transaction-btn').forEach(btn => btn.addEventListener('click', handleDeleteTransaction));
        }

        function renderGraphDetailPage() {
            const content = `
                <div class="mb-6 flex flex-wrap gap-4 items-center">
                    <div>
                        <span class="font-semibold mr-2">データ:</span>
                        <button class="toggle-btn data-toggle px-4 py-2 rounded-lg" data-type="expense">支出</button>
                        <button class="toggle-btn data-toggle px-4 py-2 rounded-lg" data-type="income">収入</button>
                        <button class="toggle-btn data-toggle px-4 py-2 rounded-lg" data-type="combined">全体</button>
                    </div>
                    <div id="chart-type-toggle-container">
                        <span class="font-semibold mr-2">グラフ:</span>
                        <button class="toggle-btn chart-toggle px-4 py-2 rounded-lg" data-type="doughnut">円</button>
                        <button class="toggle-btn chart-toggle px-4 py-2 rounded-lg" data-type="bar">棒</button>
                    </div>
                </div>
                <div class="w-full h-[60vh] relative"><canvas id="detail-chart-canvas"></canvas></div>`;
            renderDetailView('graph', '詳細分析', content);
            
            let currentDataType = 'expense', currentChartType = 'doughnut';

            const redraw = () => {
                document.querySelectorAll('.data-toggle').forEach(b => b.classList.toggle('active', b.dataset.type === currentDataType));
                document.querySelectorAll('.chart-toggle').forEach(b => b.classList.toggle('active', b.dataset.type === currentChartType));
                document.getElementById('chart-type-toggle-container').style.display = currentDataType === 'combined' ? 'none' : 'block';
                const monthlyTransactions = localTransactions.filter(t => t.date?.toDate() >= new Date(new Date().getFullYear(), new Date().getMonth(), 1));
                if (currentDataType === 'combined') {
                    renderCombinedChart(document.getElementById('detail-chart-canvas'));
                } else {
                    renderCategoryChart(document.getElementById('detail-chart-canvas'), monthlyTransactions, currentDataType, currentChartType, false);
                }
            };
            
            document.querySelectorAll('.data-toggle').forEach(btn => btn.addEventListener('click', e => {
                currentDataType = e.target.dataset.type;
                if (currentDataType === 'combined') currentChartType = 'bar';
                redraw();
            }));
            document.querySelectorAll('.chart-toggle').forEach(btn => btn.addEventListener('click', e => {
                currentChartType = e.target.dataset.type;
                redraw();
            }));
            redraw();
        }

        function renderBudgetPage() {
            const content = `<div id="budget-list-detail" class="space-y-4"></div>
                <form id="budget-form-detail" class="mt-6 flex gap-2">
                    <select id="budget-category-detail" class="w-full p-2 border border-gray-300 rounded-lg" required></select>
                    <input type="number" id="budget-amount-detail" placeholder="予算額" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">設定</button>
                </form>`;
            renderDetailView('budget', '予算管理', content);
            renderBudgets();
            
            const budgetCategoryEl = document.getElementById('budget-category-detail');
            if (budgetCategoryEl) {
                budgetCategoryEl.innerHTML = categories.expense.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                document.getElementById('budget-form-detail').addEventListener('submit', handleBudgetFormSubmit);
            }
        }

        // === DOM要素作成 & 個別レンダリング ===
        function createTransactionItem(t) {
            const itemEl = document.createElement('div');
            const isIncome = t.type === 'income';
            const date = t.date?.toDate();
            const formattedDate = date ? `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}` : '日付なし';
            
            itemEl.className = 'flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 border-b border-gray-100';
            itemEl.innerHTML = `<div class="flex items-center truncate"><div class="w-10 h-10 rounded-full flex items-center justify-center mr-4 flex-shrink-0 ${isIncome ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}"><i class="fas ${isIncome ? 'fa-arrow-up' : 'fa-arrow-down'}"></i></div><div class="truncate"><p class="font-bold truncate">${t.category}</p><p class="text-sm text-gray-500 truncate">${t.description || formattedDate}</p></div></div><div class="text-right flex-shrink-0 pl-2"><p class="font-bold text-lg ${isIncome ? 'text-green-600' : 'text-red-600'}">${isIncome ? '+' : '-'}${t.amount.toLocaleString()}円</p><button class="delete-transaction-btn text-xs text-gray-400 hover:text-red-500" data-id="${t.id}" data-category="${t.category}" data-amount="${t.amount}"><i class="fas fa-trash-alt mr-1"></i>削除</button></div>`;
            return itemEl;
        }

        function renderCategoryChart(canvas, transactions, dataType, chartType, isDashboard) {
            if (!canvas) return;
            const chartInstance = isDashboard ? dashboardChart : detailChart;
            if (chartInstance) chartInstance.destroy();
            
            const data = transactions.filter(t => t.type === dataType).reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {});
            const labels = Object.keys(data), values = Object.values(data);
            
            const parent = canvas.parentElement;
            let noDataEl = parent.querySelector('.no-data-msg');
            if (!noDataEl) {
                noDataEl = document.createElement('p');
                noDataEl.className = 'no-data-msg absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-gray-500 text-center';
                parent.appendChild(noDataEl);
            }
            noDataEl.textContent = labels.length === 0 ? `今月の${dataType === 'income' ? '収入' : '支出'}データがありません。` : '';
            
            const newChart = new Chart(canvas.getContext('2d'), { type: chartType, data: { labels, datasets: [{ label: dataType === 'income' ? '収入' : '支出', data: values, backgroundColor: chartColors[dataType], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: chartType === 'doughnut', position: 'bottom', labels: { padding: 15 } } } } });
            if (isDashboard) dashboardChart = newChart; else detailChart = newChart;
        }

        function renderWeeklyExpenseChart() {
            const canvas = document.getElementById('weekly-expense-chart');
            if (!canvas) return;
            if (weeklyChart) weeklyChart.destroy();

            const today = new Date();
            const last7Days = Array.from({length: 7}, (_, i) => {
                const d = new Date();
                d.setDate(today.getDate() - i);
                return d.toISOString().split('T')[0];
            }).reverse();

            const expenseByDay = last7Days.reduce((acc, dateStr) => {
                acc[dateStr] = 0;
                return acc;
            }, {});

            localTransactions.forEach(t => {
                if (t.type === 'expense' && t.date) {
                    const dateStr = t.date.toDate().toISOString().split('T')[0];
                    if (dateStr in expenseByDay) {
                        expenseByDay[dateStr] += t.amount;
                    }
                }
            });

            weeklyChart = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: last7Days.map(d => new Date(d).toLocaleDateString('ja-JP', { weekday: 'short' })),
                    datasets: [{
                        label: '支出',
                        data: Object.values(expenseByDay),
                        backgroundColor: 'rgba(239, 68, 68, 0.6)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: value => `¥${value.toLocaleString()}` } },
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function renderCombinedChart(canvas) {
            if (detailChart) detailChart.destroy();
            const monthlyData = localTransactions.reduce((acc, t) => {
                const month = t.date.toDate().toISOString().slice(0, 7);
                if (!acc[month]) acc[month] = { income: 0, expense: 0 };
                acc[month][t.type] += t.amount;
                return acc;
            }, {});
            const sortedMonths = Object.keys(monthlyData).sort();
            detailChart = new Chart(canvas.getContext('2d'), { type: 'bar', data: { labels: sortedMonths, datasets: [ { label: '収入', data: sortedMonths.map(m => monthlyData[m].income), backgroundColor: '#22c55e' }, { label: '支出', data: sortedMonths.map(m => monthlyData[m].expense), backgroundColor: '#ef4444' } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: value => `¥${value.toLocaleString()}` } } } } });
        }

        function renderBudgets() {
            const monthlyTransactions = localTransactions.filter(t => t.date?.toDate() >= new Date(new Date().getFullYear(), new Date().getMonth(), 1));
            const budgetListEl = document.getElementById('budget-list') || document.getElementById('budget-list-detail');
            if (!budgetListEl) return;
            budgetListEl.innerHTML = '';
            const monthlyExpenses = monthlyTransactions.filter(t => t.type === 'expense').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {});
            if (localBudgets.length === 0) { budgetListEl.innerHTML = '<p class="text-gray-500 text-center p-4">予算が設定されていません。</p>'; return; }
            const budgetCategoryEl = document.getElementById('budget-category');
            if (budgetCategoryEl) budgetCategoryEl.innerHTML = categories.expense.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            localBudgets.forEach(budget => {
                const spent = monthlyExpenses[budget.id] || 0, remaining = budget.amount - spent;
                const percentage = budget.amount > 0 ? Math.min((spent / budget.amount) * 100, 100) : 0;
                let progressBarColor = 'bg-blue-500';
                if (percentage > 75) progressBarColor = 'bg-yellow-500';
                if (percentage >= 100) progressBarColor = 'bg-red-500';
                const budgetEl = document.createElement('div');
                budgetEl.innerHTML = `<div class="flex justify-between items-center mb-1"><span class="font-semibold">${budget.id}</span><span class="text-sm ${remaining < 0 ? 'text-red-600 font-bold' : 'text-gray-600'}">${spent.toLocaleString()} / ${budget.amount.toLocaleString()} 円</span></div><div class="progress-bar bg-gray-200 rounded-full h-2.5"><div class="progress-bar ${progressBarColor} h-2.5 rounded-full" style="width: ${percentage}%;"></div></div>${remaining < 0 ? `<p class="text-xs text-right text-red-600 font-bold mt-1">${Math.abs(remaining).toLocaleString()}円の超過</p>` : ''}`;
                budgetListEl.appendChild(budgetEl);
            });
        }
        
        // === ナビゲーション ===
        function navigateTo(viewName, isRefresh = false) {
            const dashboardView = document.getElementById('dashboard-view');
            const detailView = document.getElementById('detail-view');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('text-indigo-600', b.dataset.view === viewName));

            if (viewName === 'dashboard') {
                detailView.classList.add('hidden');
                dashboardView.style.display = 'block';
                document.getElementById('dashboard-subtitle').textContent = "ダッシュボード";
            } else {
                dashboardView.style.display = 'none';
                detailView.classList.remove('hidden');
                switch(viewName) {
                    case 'all': renderTransactionDetailPage('all'); break;
                    case 'income': renderTransactionDetailPage('income'); break; // for card click
                    case 'expense': renderTransactionDetailPage('expense'); break; // for card click
                    case 'graph': renderGraphDetailPage(); break;
                    case 'budget': renderBudgetPage(); break;
                }
            }
            if (!isRefresh) window.scrollTo(0, 0);
        }

        // === ヘルパー & イベントハンドラ ===
        function displayAuthInfo(user) {
            const authInfoEl = document.getElementById('auth-info');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            if (user && !user.isAnonymous) {
                authInfoEl.innerHTML = `<p class="font-semibold">${user.displayName || 'ユーザー'}</p><p>ID: <span class="font-mono bg-gray-200 px-1 rounded">${user.uid.slice(0,10)}...</span></p>`;
                googleLoginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                authInfoEl.innerHTML = `<p>ゲストとして利用中</p><p>データは一時的なものです</p>`;
                googleLoginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        }

        function setSaveStatus(status, message = '') {
            const statusEl = document.getElementById('save-status');
            let color = 'text-gray-500', dotColor = 'bg-gray-500', text = '不明';
            switch(status) {
                case 'loading': text = '読み込み中...'; color = 'text-blue-500'; dotColor = 'bg-blue-500 status-dot loading'; break;
                case 'saving': text = '保存中...'; color = 'text-orange-500'; dotColor = 'bg-orange-500 status-dot saving'; break;
                case 'ai': text = message || 'AIが考え中...'; color = 'text-purple-500'; dotColor = 'bg-purple-500 status-dot ai'; break;
                case 'idle': text = '動作中'; color = 'text-green-500'; dotColor = 'bg-green-500'; break;
                case 'error': text = message || '保存失敗'; color = 'text-red-500'; dotColor = 'bg-red-500'; break;
            }
            statusEl.innerHTML = `<div class="status-dot ${dotColor}"></div><span class="${color}">${text}</span>`;
        }

        function downloadFile(filename, content, type) {
            const blob = new Blob([content], { type });
            const a = document.createElement('a');
a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }

        function handleDeleteTransaction(e) {
            e.stopPropagation();
            const { id, category, amount } = e.currentTarget.dataset;
            showConfirmModal('取引の削除', `「${category}」の取引（${parseInt(amount).toLocaleString()}円）を削除しますか？`, () => {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-kakeibo-app';
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, id);
                handleFirestoreWrite(deleteDoc(docRef));
            });
        }

        function handleBudgetFormSubmit(e) {
            e.preventDefault();
            const categoryEl = e.target.querySelector('select');
            const amountEl = e.target.querySelector('input');
            const category = categoryEl.value;
            const amount = parseInt(amountEl.value);
            if (category && !isNaN(amount) && amount >= 0) {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-kakeibo-app';
                const budgetDocRef = doc(db, `artifacts/${appId}/users/${userId}/budgets`, category);
                if (handleFirestoreWrite(setDoc(budgetDocRef, { amount }))) e.target.reset();
            }
        }

        // === モーダル関連 ===
        function showTransactionModal() {
            const modalContainer = document.getElementById('transaction-modal');
            modalContainer.innerHTML = `<div class="card w-full max-w-lg"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">新しい取引を追加</h2><button id="close-transaction-modal-btn" class="text-gray-500 hover:text-gray-800"><i class="fas fa-times fa-2x"></i></button></div><form id="transaction-form"><div class="mb-4"><label class="block text-gray-700 mb-2">種類</label><div class="flex"><button type="button" id="type-income-btn" class="toggle-btn flex-1 p-3 rounded-l-lg border-2 border-green-500">収入</button><button type="button" id="type-expense-btn" class="toggle-btn flex-1 p-3 rounded-r-lg border-2 border-red-500">支出</button></div><input type="hidden" id="transaction-type" required></div><div class="mb-4"><label for="transaction-date" class="block text-gray-700 mb-2">日付</label><input type="date" id="transaction-date" class="w-full p-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="transaction-amount" class="block text-gray-700 mb-2">金額</label><input type="number" id="transaction-amount" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="例: 3000" required></div><div class="mb-6"><label for="transaction-description" class="block text-gray-700 mb-2">内容</label><div class="flex gap-2"><input type="text" id="transaction-description" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="例: スーパーで野菜と肉購入"><button type="button" id="ai-categorize-btn" class="p-3 bg-indigo-100 hover:bg-indigo-200 rounded-lg text-indigo-800" title="AIにおまかせ">✨</button></div></div><div class="mb-4"><label for="transaction-category" class="block text-gray-700 mb-2">カテゴリ</label><select id="transaction-category" class="w-full p-3 border border-gray-300 rounded-lg" required></select></div><button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg">保存</button></form></div>`;
            modalContainer.classList.add('is-open');

            const form = document.getElementById('transaction-form');
            document.getElementById('close-transaction-modal-btn').addEventListener('click', () => modalContainer.classList.remove('is-open'));
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newTransaction = { type: form.elements['transaction-type'].value, date: new Date(form.elements['transaction-date'].value), amount: parseInt(form.elements['transaction-amount'].value), category: form.elements['transaction-category'].value, description: form.elements['transaction-description'].value, createdAt: serverTimestamp() };
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-kakeibo-app';
                if (await handleFirestoreWrite(addDoc(collection(db, `artifacts/${appId}/users/${userId}/transactions`), newTransaction))) modalContainer.classList.remove('is-open');
            });
            
            document.getElementById('ai-categorize-btn').addEventListener('click', (e) => {
                const description = form.elements['transaction-description'].value;
                if (description) getAICategory(description);
                else alert('先に内容を入力してください。');
            });

            const toggleTransactionType = type => {
                const categoryEl = form.elements['transaction-category'];
                categoryEl.innerHTML = (type === 'income' ? categories.income : categories.expense).map(cat => `<option value="${cat}">${cat}</option>`).join('');
                form.elements['transaction-type'].value = type;
                document.getElementById('type-income-btn').classList.toggle('active', type === 'income');
                document.getElementById('type-expense-btn').classList.toggle('active', type === 'expense');
            };
            
            document.getElementById('type-income-btn').addEventListener('click', () => toggleTransactionType('income'));
            document.getElementById('type-expense-btn').addEventListener('click', () => toggleTransactionType('expense'));
            form.elements['transaction-date'].valueAsDate = new Date();
            toggleTransactionType('expense');
        }

        function showConfirmModal(title, body, onOk) {
            const modalContainer = document.getElementById('confirm-modal');
            modalContainer.innerHTML = `<div class="card w-full max-w-sm"><h3 class="text-lg font-bold mb-4">${title}</h3><p class="text-gray-600 mb-6">${body}</p><div class="flex justify-end gap-4"><button id="confirm-modal-cancel" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">キャンセル</button><button id="confirm-modal-ok" class="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600">実行</button></div></div>`;
            modalContainer.classList.add('is-open');
            const close = () => modalContainer.classList.remove('is-open');
            document.getElementById('confirm-modal-ok').addEventListener('click', () => { onOk(); close(); });
            document.getElementById('confirm-modal-cancel').addEventListener('click', close);
        }

        // === イベントリスナー設定 ===
        function setupEventListeners() {
            document.getElementById('google-login-btn').addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()).catch(() => setSaveStatus('error', 'ログイン失敗')));
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth).catch(() => setSaveStatus('error', 'ログアウト失敗')));
            
            document.getElementById('view-toggle-btn').addEventListener('click', e => {
                const isMobile = document.body.classList.toggle('mobile-view');
                e.currentTarget.innerHTML = `<i class="fas ${isMobile ? 'fa-mobile-screen-button' : 'fa-desktop'}"></i>`;
            });

            document.getElementById('balance-card').addEventListener('click', () => navigateTo('all'));
            document.getElementById('income-card').addEventListener('click', () => renderTransactionDetailPage('income'));
            document.getElementById('expense-card').addEventListener('click', () => renderTransactionDetailPage('expense'));
            document.getElementById('expense-chart-card').addEventListener('click', () => navigateTo('graph'));
            document.getElementById('add-transaction-desktop-btn').addEventListener('click', showTransactionModal);
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.view)));
            document.getElementById('add-transaction-mobile-btn').addEventListener('click', showTransactionModal);

            document.getElementById('force-sync-btn').addEventListener('click', loadAndDisplayData);
            document.getElementById('download-json-btn').addEventListener('click', () => downloadFile('kakeibo-data.json', JSON.stringify(localTransactions.map(t => ({...t, date: t.date?.toDate()})), null, 2), 'application/json'));
            document.getElementById('download-csv-btn').addEventListener('click', () => {
                const headers = ['id', 'type', 'date', 'amount', 'category', 'description'];
                const csvContent = [ headers.join(','), ...localTransactions.map(t => headers.map(h => `"${String(h === 'date' ? t[h]?.toDate().toISOString() : t[h] ?? '').replace(/"/g, '""')}"`).join(',')) ].join('\n');
                downloadFile('kakeibo-data.csv', csvContent, 'text/csv;charset=utf-8;');
            });
            
            document.getElementById('budget-form').addEventListener('submit', handleBudgetFormSubmit);

            // AI機能のイベントリスナー
            document.getElementById('get-ai-summary-btn').addEventListener('click', getAISummary);
            document.getElementById('get-ai-tips-btn').addEventListener('click', getAITips);
            
            // ESCキーで戻る/閉じる機能
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const transactionModal = document.getElementById('transaction-modal');
                    const confirmModal = document.getElementById('confirm-modal');
                    const aiTipsModal = document.getElementById('ai-tips-modal');

                    if (transactionModal.classList.contains('is-open')) {
                        transactionModal.classList.remove('is-open');
                    } else if (confirmModal.classList.contains('is-open')) {
                        confirmModal.classList.remove('is-open');
                    } else if (aiTipsModal.classList.contains('is-open')) {
                        aiTipsModal.classList.remove('is-open');
                    } else if (!document.getElementById('detail-view').classList.contains('hidden')) {
                        navigateTo('dashboard');
                    }
                }
            });
        }
    </script>

</body>
</html>
